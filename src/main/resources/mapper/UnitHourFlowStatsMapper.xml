<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.metoo.nrsm.core.mapper.UnitHourFlowStatsMapper">


    <select id="selectObjByMap" parameterType="java.util.Map" resultType="com.metoo.nrsm.entity.UnitHourFlowStats">
        SELECT
            id, unit_id, unit_name, ipv4, ipv6,
            hour_time, day, month, year, stats_time
        FROM unit_hour_flow_stats
        <where>
            <if test="unitId != null">
                AND unit_id = #{unitId}
            </if>
            <if test="day != null">
                AND day = #{day}
            </if>
            <if test="month != null">
                AND month = #{month}
            </if>
            <if test="year != null">
                AND year = #{year}
            </if>
        </where>
    </select>

    <select id="selectDailyTotalFlow" parameterType="map" resultType="map">
        SELECT
            SUM(ipv4) AS totalIPv4,
            SUM(ipv6) AS totalIPv6
        FROM unit_hour_flow_stats
        WHERE unit_id = #{unitId}
        AND day = #{day}
    </select>

    <!-- 月流量统计查询 -->
    <select id="selectMonthlyTotalFlow" parameterType="map" resultType="map">
        SELECT
            SUM(ipv4) AS totalIPv4,
            SUM(ipv6) AS totalIPv6
        FROM unit_hour_flow_stats
        WHERE unit_id = #{unitId}
        AND year = #{year}
        AND month = #{month}
  </select>

    <select id="selectByUnitIdAndTime" resultType="com.metoo.nrsm.entity.UnitHourFlowStats">
        SELECT * FROM unit_hour_flow_stats
        WHERE unit_id = #{unit_id}
          AND year = #{year}
          AND month = #{month}
          AND day = #{day}
          AND hour_time = #{hour_time}
        LIMIT 1
    </select>

    <!-- 动态更新记录 -->
    <update id="update" parameterType="com.metoo.nrsm.entity.UnitHourFlowStats">
        UPDATE unit_hour_flow_stats
        <set>
            <if test="ipv4 != null">ipv4 = #{ipv4},</if>
            <if test="ipv6 != null">ipv6 = #{ipv6},</if>
            <if test="stats_time != null">stats_time = #{stats_time},</if>
        </set>
        WHERE unit_id = #{unit_id}
        AND year = #{year}
        AND month = #{month}
        AND day = #{day}
        AND hour_time = #{hour_time}
    </update>

    <insert id="save" parameterType="com.metoo.nrsm.entity.UnitHourFlowStats">
        INSERT INTO unit_hour_flow_stats
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">id,</if>
            <if test="unitId != null">unit_id,</if>
            <if test="unitName != null">unit_name,</if>
            <if test="ipv4 != null">ipv4,</if>
            <if test="ipv6 != null">ipv6,</if>
            <if test="hourTime != null">hour_time,</if>
            <if test="day != null">day,</if>
            <if test="day != null">month,</if>
            <if test="day != null">year,</if>
            <if test="statsTime != null">stats_time,</if>
        </trim>
        <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
            <if test="id != null">#{id},</if>
            <if test="unitId != null">#{unitId},</if>
            <if test="unitName != null">#{unitName},</if>
            <if test="ipv4 != null">#{ipv4},</if>
            <if test="ipv6 != null">#{ipv6},</if>
            <if test="hourTime != null">#{hourTime},</if>
            <if test="day != null">#{day},</if>
            <if test="day != null">#{month},</if>
            <if test="day != null">#{year},</if>
            <if test="statsTime != null">#{statsTime},</if>
        </trim>
    </insert>

    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO unit_hour_flow_stats (
        unit_id, ipv4, ipv6, hour_time, day, month, year, stats_time
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.unit_id}, #{item.ipv4}, #{item.ipv6},
                #{item.hour_time}, #{item.day}, #{item.month},#{item.year}, #{item.stats_time}
            )
        </foreach>
    </insert>

    <select id="orgHour" resultType="com.metoo.nrsm.core.manager.statis.vo.FlowRadioData">
        select a.hour_time as title,SUM(COALESCE(a.ipv4,0)) as ipv4,SUM(COALESCE(a.ipv6,0)) as ipv6,COALESCE(Round((SUM(COALESCE(a.ipv6,0)))*100/(SUM(COALESCE(a.ipv4,0))+SUM(COALESCE(a.ipv6,0)))),0) as ipv6Radio from unit_hour_flow_stats  a
        where 1=1
        <if test="id != null and id !=''">
            and a.unit_id=#{id}
        </if>
          and a.day =#{day}
        group by a.hour_time
        ORDER BY a.hour_time  asc
    </select>
</mapper>
